<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Final Student Availability & Booking Form</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 20px; background:#fafafa }
    h1 { margin-bottom: 6px }
    p { margin-top: 0; color:#555 }
    table { border-collapse: collapse; width: 100%; margin-top: 16px }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 12px; vertical-align: top }
    th { background: #f0f0f0; position: sticky; top: 0 }
    .time { font-weight: 600; background:#fff; white-space:nowrap }
    textarea { width: 95%; height: 36px; font-size: 11px }
    input[type=checkbox] { transform: scale(1.1) }
    .controls { margin-top: 12px }
    button { padding: 8px 14px; font-size: 14px; margin-right:6px }
    .hidden { display:none }
    .slot { font-size:11px }
  </style>
</head>
<body>

<h1>Weekly Availability & Class Booking</h1>
<p>90-minute slots • 10:00 AM – 8:00 PM • Monday–Sunday</p>

<div class="controls">
  <label>Name <input id="name" /></label>
  <label>Class <input id="studentClass" /></label>
  <button onclick="loadMyData()">Load</button>
  <button onclick="saveAvailability()">Save Availability</button>
  <button onclick="toggleBookingMode()">Final Booking</button>
</div>

<table id="availabilityGrid">
  <thead>
    <tr>
      <th>Time</th>
      <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<table id="bookingGrid" class="hidden">
  <thead>
    <tr>
      <th>Day</th>
      <th>Time</th>
      <th>Available Seats</th>
      <th>Book</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ================= CONFIG =================
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOSE9BWt4rUpQc1M8-VIJWtQeNDkJwMQ3QWdkTckGgWHUr3pwtl-d_XlROxpMztIh1/execE";
const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const START = 10;
const END = 20;
let bookingMode = false;

// ================= BUILD AVAILABILITY GRID =================
const tbody = document.querySelector('#availabilityGrid tbody');
function fmt(h){ const t=h%12||12; return `${t}:00 ${h<12?'AM':'PM'}` }
for(let h=START;h<=END;h+=1.5){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td class='time'>${fmt(Math.floor(h))} – ${fmt(Math.floor(h+1.5))}</td>`;
  DAYS.forEach(d=>{
    const td=document.createElement('td');
    td.innerHTML=`<input type='checkbox' data-d='${d}' data-h='${h}'>
                  <br><textarea data-d='${d}' data-h='${h}' placeholder='Notes'></textarea>`;
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
}

// ================= LOAD STUDENT DATA =================
async function loadMyData(){
  const name=document.getElementById('name').value.trim();
  if(!name) return alert('Enter name');
  const res=await fetch(`${GOOGLE_SCRIPT_URL}?name=${encodeURIComponent(name)}`);
  const data=await res.json();

  document.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false);
  document.querySelectorAll('textarea').forEach(t=>t.value='');

  data.forEach(e=>{
    const cb=document.querySelector(`input[data-d='${e.day}'][data-h='${e.time}']`);
    const ta=document.querySelector(`textarea[data-d='${e.day}'][data-h='${e.time}']`);
    if(cb) cb.checked = e.available === 'YES';
    if(ta) ta.value = e.note || '';
  });
}

// ================= SAVE AVAILABILITY =================
async function saveAvailability(){
  const name=document.getElementById('name').value.trim();
  if(!name) return alert('Enter name');
  const cls=document.getElementById('studentClass').value.trim();

  const payload=[];
  document.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    const d=cb.dataset.d;
    const h=cb.dataset.h;
    const note=document.querySelector(`textarea[data-d='${d}'][data-h='${h}']`).value;
    payload.push({ name, studentClass:cls, day:d, time:h, available:cb.checked, note });
  });

  await fetch(GOOGLE_SCRIPT_URL,{ method:'POST', body:JSON.stringify(payload) });
  alert('Availability saved');
}

// ================= BOOKING MODE =================
async function toggleBookingMode(){
  bookingMode=!bookingMode;
  document.getElementById('availabilityGrid').classList.toggle('hidden',bookingMode);
  document.getElementById('bookingGrid').classList.toggle('hidden',!bookingMode);
  if(bookingMode) loadFinalSlots();
}

async function loadFinalSlots(){
  const res=await fetch(`${GOOGLE_SCRIPT_URL}?mode=final`);
  const data=await res.json();
  const tbody=document.querySelector('#bookingGrid tbody');
  tbody.innerHTML='';
  data.forEach(s=>{
    const remaining = s.capacity - s.booked;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.day}</td><td>${fmt(Math.floor(s.time))}</td>
                  <td>${remaining}</td>
                  <td><button ${remaining<=0?'disabled':''} onclick="bookSlot('${s.day}','${s.time}')">Book</button></td>`;
    tbody.appendChild(tr);
  });
}

async function bookSlot(day,time){
  const name=document.getElementById('name').value.trim();
  if(!name) return alert('Enter name');
  await fetch(`${GOOGLE_SCRIPT_URL}?mode=book&day=${day}&time=${time}&name=${encodeURIComponent(name)}`);
  alert('Booked');
  loadFinalSlots();
}
</script>

</body>
</html>
